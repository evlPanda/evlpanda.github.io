<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.5.0 -->
<title>SQL Intersection Method (a.k.a. Dr Suess) | The PeopleSoft Experience</title>
<meta name="generator" content="Jekyll v3.8.3" />
<meta property="og:title" content="SQL Intersection Method (a.k.a. Dr Suess)" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="This handy piece of SQL will return all the dates where criteria is valid across any number of tables. Say you wanted to find the dates that an employee has &#39;x&#39; in table a, &#39;y&#39; in table b, and &#39;z&#39; in table c you could use the following. Written for DB2, use &#39;dual&#39; in place of sysibm.dummy1 in Oracle etc. Note that all tables must have a &quot;start date&quot; and an &quot;end date&quot; field (although &quot;end date&quot; can be blank)." />
<meta property="og:description" content="This handy piece of SQL will return all the dates where criteria is valid across any number of tables. Say you wanted to find the dates that an employee has &#39;x&#39; in table a, &#39;y&#39; in table b, and &#39;z&#39; in table c you could use the following. Written for DB2, use &#39;dual&#39; in place of sysibm.dummy1 in Oracle etc. Note that all tables must have a &quot;start date&quot; and an &quot;end date&quot; field (although &quot;end date&quot; can be blank)." />
<link rel="canonical" href="http://localhost:4000/2016/02/09/sql-intersection-method-a-k-a-dr-suess.html" />
<meta property="og:url" content="http://localhost:4000/2016/02/09/sql-intersection-method-a-k-a-dr-suess.html" />
<meta property="og:site_name" content="The PeopleSoft Experience" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2016-02-09T00:52:26+11:00" />
<script type="application/ld+json">
{"description":"This handy piece of SQL will return all the dates where criteria is valid across any number of tables. Say you wanted to find the dates that an employee has &#39;x&#39; in table a, &#39;y&#39; in table b, and &#39;z&#39; in table c you could use the following. Written for DB2, use &#39;dual&#39; in place of sysibm.dummy1 in Oracle etc. Note that all tables must have a &quot;start date&quot; and an &quot;end date&quot; field (although &quot;end date&quot; can be blank).","@type":"BlogPosting","url":"http://localhost:4000/2016/02/09/sql-intersection-method-a-k-a-dr-suess.html","headline":"SQL Intersection Method (a.k.a. Dr Suess)","dateModified":"2016-02-09T00:52:26+11:00","datePublished":"2016-02-09T00:52:26+11:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2016/02/09/sql-intersection-method-a-k-a-dr-suess.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="The PeopleSoft Experience" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">The PeopleSoft Experience</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">SQL Intersection Method (a.k.a. Dr Suess)</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2016-02-09T00:52:26+11:00" itemprop="datePublished">Feb 9, 2016
      </time>â€¢ <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">{"login"=>"evlpanda", "email"=>"m.nitschke@gmail.com", "display_name"=>"Michael Nitschke", "first_name"=>"", "last_name"=>""}</span></span></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>This handy piece of SQL will return all the dates where criteria is valid across any number of tables. Say you wanted to find the dates that an employee has 'x' in table a, 'y' in table b, and 'z' in table c you could use the following.</p>
<p>Written for DB2, use 'dual' in place of sysibm.dummy1 in Oracle etc.</p>
<p>Note that all tables must have a "start date" and an "end date" field (although "end date" can be blank).</p>
<pre><code>

/* Adjust daterange to suit. */
with daterange(dt) as (
   select current date - 2 year
   from sysibm.sysdummy1
   union all
   select dt + 1 day
   from daterange
   where dt &lt; current date + 2 years
)

select
  a.some_field as key_field_1
, a.some_other_field as key_field_2
, x.dt as key_field_3
, c.etcetera

from
  daterange x
, some_table_a a
, some_table_b b
, some_table_c c

where a.some_field = 'x'

and b.keyfields = a.keyfields
and b.some_field = 'y'

and c.keyfields = b.keyfields
and c.some_other_field = 'z'

/* 
   Begin Intersection method.
   Find only rows that overlap other rows in other tables. 
   All combinations = a:b, a:c, b:c 
*/

/* a:b */
and (
      (a.start_dt between b.start_dt and b.end_dt
      or b.start_dt between a.start_dt and a.end_dt)
   or
      (a.end_dt is null
      and b.start_dt &gt;= a.start_dt)
   or
      (b.end_dt is null
      and a.start_dt &gt;= b.start_dt)
)

/* a:c */
and (
      (a.start_dt between c.start_dt and c.end_dt
      or c.start_dt between a.start_dt and a.end_dt)
   or
      (a.end_dt is null
      and c.start_dt &gt;= a.start_dt)
   or
      (c.end_dt is null
      and a.start_dt &gt;= c.start_dt)
)

/* b:c */
and (
      (b.start_dt between c.start_dt and c.end_dt
      or c.start_dt between b.start_dt and b.end_dt)
   or
      (b.end_dt is null
      and c.start_dt &gt;= b.start_dt)
   or
      (c.end_dt is null
      and b.start_dt &gt;= c.start_dt)
)

/* Return only days that are between the overlapping date ranges. */
and x.dt between
   greatest(a.start_dt, b.start_dt, c.start_dt)
and
   least(
     nvl(a.end_dt, date('3000-01-01'))
   , nvl(b.end_dt, date('3000-01-01'))
   , nvl(c.end_dt, date('3000-01-01')))

/* Return only one day per overlap. Group by key fields. */
group by a.some_field, a.some_other_field, x.dt

</code></pre>
<h3>Bonus!</h3>
<p>PeopleCode to write the intersection method for you! This avoids getting hynotised by the pattern when you're doing it for six or more tables and is correct every time.</p>
<pre><code>
Local array of string &amp;arrAliases = Split(ADO_INTERSECTN.TEXT254.Value, ",");

ADO_INTERSECTN.HTML_AREA_01.Value = "";

Local integer &amp;i, &amp;j;
Local string &amp;str;

For &amp;i = 1 To &amp;arrAliases.Len
   For &amp;j = &amp;i + 1 To &amp;arrAliases.Len
      
      &amp;str = &amp;str | "/* " | &amp;arrAliases [&amp;i] | " - " | &amp;arrAliases [&amp;j] | " */";
      &amp;str = &amp;str | " AND ( (" | &amp;arrAliases [&amp;i] | ".start_dt BETWEEN " | &amp;arrAliases [&amp;j] | ".start_dt AND " | &amp;arrAliases [&amp;j] | ".end_dt ";
      &amp;str = &amp;str | "OR " | &amp;arrAliases [&amp;j] | ".start_dt BETWEEN " | &amp;arrAliases [&amp;i] | ".start_dt AND " | &amp;arrAliases [&amp;i] | ".end_dt) ";
      &amp;str = &amp;str | "OR (" | &amp;arrAliases [&amp;i] | ".end_dt IS NULL ";
      &amp;str = &amp;str | "AND " | &amp;arrAliases [&amp;j] | ".start_dt &gt;= " | &amp;arrAliases [&amp;i] | ".start_dt) ";
      &amp;str = &amp;str | "OR (" | &amp;arrAliases [&amp;j] | ".end_dt IS NULL ";
      &amp;str = &amp;str | "AND " | &amp;arrAliases [&amp;i] | ".start_dt &gt;= " | &amp;arrAliases [&amp;j] | ".start_dt) ) ";
      
   End-For;
End-For;

&amp;str = &amp;str | " and x.date1 between greatest(";
For &amp;i = 1 To &amp;arrAliases.Len
   &amp;str = &amp;str | &amp;arrAliases [&amp;i] | ".start_dt, ";
End-For;
&amp;str = Left(&amp;str, Len(&amp;str) - 2);

&amp;str = &amp;str | ") and least(";
For &amp;i = 1 To &amp;arrAliases.Len
   &amp;str = &amp;str | "nvl(" | &amp;arrAliases [&amp;i] | ".end_dt, date('3000-01-01')), ";
End-For;
&amp;str = Left(&amp;str, Len(&amp;str) - 2);
&amp;str = &amp;str | ")";


ADO_INTERSECTN.HTML_AREA_01.Value = &amp;str;
</code></pre></p>

  </div><a class="u-url" href="/2016/02/09/sql-intersection-method-a-k-a-dr-suess.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">The PeopleSoft Experience</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">The PeopleSoft Experience</li><li><a class="u-email" href="mailto:your-email@example.com">your-email@example.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/evlPanda"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">evlPanda</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Musings, chit-chat, and sometimes useful stuff related to PeopleSoft, especially PeopleCode.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
