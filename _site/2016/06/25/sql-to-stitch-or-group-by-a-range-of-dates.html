<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.5.0 -->
<title>SQL to Stitch or Group By a Range of Dates | The PeopleSoft Experience</title>
<meta name="generator" content="Jekyll v3.8.3" />
<meta property="og:title" content="SQL to Stitch or Group By a Range of Dates" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="So, for a reason beyond your control you have data in the following format: EMPLID DATE1 COMPANY DEPARTMENT PROJECT ----------- ---------- ---------------- -------------- ---------------- 123 2016-01-01 ACME Corporation TNT Division Sticky TNT 123 2016-01-02 ACME Corporation TNT Division Sticky TNT 123 2016-01-03 ACME Corporation TNT Division Sticky TNT 123 2016-01-04 ACME Corporation TNT Division Sticky TNT 123 2016-01-05 ACME Corporation TNT Division Sticky TNT 123 2016-01-06 ACME Corporation Juice Division Apple Juice 123 2016-01-07 ACME Corporation Juice Division Apple Juice 123 2016-01-08 ACME Corporation Juice Division Apple Juice 123 2016-01-09 ACME Corporation Juice Division Pineapple Juice 123 2016-01-10 ACME Corporation Juice Division Pineapple Juice 456 2016-01-01 XYZ Corporation Vapourware Magic 456 2016-01-02 XYZ Corporation Vapourware Magic 456 2016-01-03 XYZ Corporation Vapourware Magic 456 2016-01-04 XYZ Corporation Vapourware Magic 456 2016-01-05 XYZ Corporation Vapourware Magic 456 2016-01-06 Bling! p/l Vapourware Magic 456 2016-01-07 Bling! p/l Vapourware Magic 456 2016-01-08 Bling! p/l Vapourware Magic 456 2016-01-09 Bling! p/l Vapourware Candy Crush Live 456 2016-01-10 Bling! p/l Vapourware Candy Crush Live A collection of employees, individual dates, and the company, department and project they were in on that date. And you would like to get the date ranges that they were in a company, or department, or project. Here is the data to play with: with data (emplid, date1, company, department, project) as (" />
<meta property="og:description" content="So, for a reason beyond your control you have data in the following format: EMPLID DATE1 COMPANY DEPARTMENT PROJECT ----------- ---------- ---------------- -------------- ---------------- 123 2016-01-01 ACME Corporation TNT Division Sticky TNT 123 2016-01-02 ACME Corporation TNT Division Sticky TNT 123 2016-01-03 ACME Corporation TNT Division Sticky TNT 123 2016-01-04 ACME Corporation TNT Division Sticky TNT 123 2016-01-05 ACME Corporation TNT Division Sticky TNT 123 2016-01-06 ACME Corporation Juice Division Apple Juice 123 2016-01-07 ACME Corporation Juice Division Apple Juice 123 2016-01-08 ACME Corporation Juice Division Apple Juice 123 2016-01-09 ACME Corporation Juice Division Pineapple Juice 123 2016-01-10 ACME Corporation Juice Division Pineapple Juice 456 2016-01-01 XYZ Corporation Vapourware Magic 456 2016-01-02 XYZ Corporation Vapourware Magic 456 2016-01-03 XYZ Corporation Vapourware Magic 456 2016-01-04 XYZ Corporation Vapourware Magic 456 2016-01-05 XYZ Corporation Vapourware Magic 456 2016-01-06 Bling! p/l Vapourware Magic 456 2016-01-07 Bling! p/l Vapourware Magic 456 2016-01-08 Bling! p/l Vapourware Magic 456 2016-01-09 Bling! p/l Vapourware Candy Crush Live 456 2016-01-10 Bling! p/l Vapourware Candy Crush Live A collection of employees, individual dates, and the company, department and project they were in on that date. And you would like to get the date ranges that they were in a company, or department, or project. Here is the data to play with: with data (emplid, date1, company, department, project) as (" />
<link rel="canonical" href="http://localhost:4000/2016/06/25/sql-to-stitch-or-group-by-a-range-of-dates.html" />
<meta property="og:url" content="http://localhost:4000/2016/06/25/sql-to-stitch-or-group-by-a-range-of-dates.html" />
<meta property="og:site_name" content="The PeopleSoft Experience" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2016-06-25T06:38:52+10:00" />
<script type="application/ld+json">
{"description":"So, for a reason beyond your control you have data in the following format: EMPLID DATE1 COMPANY DEPARTMENT PROJECT ----------- ---------- ---------------- -------------- ---------------- 123 2016-01-01 ACME Corporation TNT Division Sticky TNT 123 2016-01-02 ACME Corporation TNT Division Sticky TNT 123 2016-01-03 ACME Corporation TNT Division Sticky TNT 123 2016-01-04 ACME Corporation TNT Division Sticky TNT 123 2016-01-05 ACME Corporation TNT Division Sticky TNT 123 2016-01-06 ACME Corporation Juice Division Apple Juice 123 2016-01-07 ACME Corporation Juice Division Apple Juice 123 2016-01-08 ACME Corporation Juice Division Apple Juice 123 2016-01-09 ACME Corporation Juice Division Pineapple Juice 123 2016-01-10 ACME Corporation Juice Division Pineapple Juice 456 2016-01-01 XYZ Corporation Vapourware Magic 456 2016-01-02 XYZ Corporation Vapourware Magic 456 2016-01-03 XYZ Corporation Vapourware Magic 456 2016-01-04 XYZ Corporation Vapourware Magic 456 2016-01-05 XYZ Corporation Vapourware Magic 456 2016-01-06 Bling! p/l Vapourware Magic 456 2016-01-07 Bling! p/l Vapourware Magic 456 2016-01-08 Bling! p/l Vapourware Magic 456 2016-01-09 Bling! p/l Vapourware Candy Crush Live 456 2016-01-10 Bling! p/l Vapourware Candy Crush Live A collection of employees, individual dates, and the company, department and project they were in on that date. And you would like to get the date ranges that they were in a company, or department, or project. Here is the data to play with: with data (emplid, date1, company, department, project) as (","@type":"BlogPosting","url":"http://localhost:4000/2016/06/25/sql-to-stitch-or-group-by-a-range-of-dates.html","headline":"SQL to Stitch or Group By a Range of Dates","dateModified":"2016-06-25T06:38:52+10:00","datePublished":"2016-06-25T06:38:52+10:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2016/06/25/sql-to-stitch-or-group-by-a-range-of-dates.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="The PeopleSoft Experience" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">The PeopleSoft Experience</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">SQL to Stitch or Group By a Range of Dates</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2016-06-25T06:38:52+10:00" itemprop="datePublished">Jun 25, 2016
      </time>â€¢ <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">{"login"=>"evlpanda", "email"=>"m.nitschke@gmail.com", "display_name"=>"Michael Nitschke", "first_name"=>"", "last_name"=>""}</span></span></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>
So, for a reason beyond your control you have data in the following format:</p>
<pre><code>
EMPLID      DATE1      COMPANY          DEPARTMENT     PROJECT         
----------- ---------- ---------------- -------------- ----------------
        123 2016-01-01 ACME Corporation TNT Division   Sticky TNT      
        123 2016-01-02 ACME Corporation TNT Division   Sticky TNT      
        123 2016-01-03 ACME Corporation TNT Division   Sticky TNT      
        123 2016-01-04 ACME Corporation TNT Division   Sticky TNT      
        123 2016-01-05 ACME Corporation TNT Division   Sticky TNT      
        123 2016-01-06 ACME Corporation Juice Division Apple Juice     
        123 2016-01-07 ACME Corporation Juice Division Apple Juice     
        123 2016-01-08 ACME Corporation Juice Division Apple Juice     
        123 2016-01-09 ACME Corporation Juice Division Pineapple Juice 
        123 2016-01-10 ACME Corporation Juice Division Pineapple Juice 
        456 2016-01-01 XYZ Corporation  Vapourware     Magic           
        456 2016-01-02 XYZ Corporation  Vapourware     Magic           
        456 2016-01-03 XYZ Corporation  Vapourware     Magic           
        456 2016-01-04 XYZ Corporation  Vapourware     Magic           
        456 2016-01-05 XYZ Corporation  Vapourware     Magic           
        456 2016-01-06 Bling! p/l       Vapourware     Magic           
        456 2016-01-07 Bling! p/l       Vapourware     Magic           
        456 2016-01-08 Bling! p/l       Vapourware     Magic           
        456 2016-01-09 Bling! p/l       Vapourware     Candy Crush Live
        456 2016-01-10 Bling! p/l       Vapourware     Candy Crush Live
</code></pre>
<p>
A collection of employees, <i>individual dates</i>, and the company, department and project they were in on that date. And you would like to get the date <i>ranges</i> that they were in a company, or department, or project.</p>
<p>Here is the data to play with:</p>
<pre><code>
with data (emplid, date1, company, department, project) as (

	select 123, date('2016-01-01'), 'ACME Corporation', 'TNT Division'  , 'Sticky TNT'        from sysibm.sysdummy1 union
	select 123, date('2016-01-02'), 'ACME Corporation', 'TNT Division'  , 'Sticky TNT'        from sysibm.sysdummy1 union
	select 123, date('2016-01-03'), 'ACME Corporation', 'TNT Division'  , 'Sticky TNT'        from sysibm.sysdummy1 union
	select 123, date('2016-01-04'), 'ACME Corporation', 'TNT Division'  , 'Sticky TNT'        from sysibm.sysdummy1 union
	select 123, date('2016-01-05'), 'ACME Corporation', 'TNT Division'  , 'Sticky TNT'        from sysibm.sysdummy1 union

	select 123, date('2016-01-06'), 'ACME Corporation', 'Juice Division', 'Apple Juice'       from sysibm.sysdummy1 union
	select 123, date('2016-01-07'), 'ACME Corporation', 'Juice Division', 'Apple Juice'       from sysibm.sysdummy1 union
	select 123, date('2016-01-08'), 'ACME Corporation', 'Juice Division', 'Apple Juice'       from sysibm.sysdummy1 union

	select 123, date('2016-01-09'), 'ACME Corporation', 'Juice Division', 'Pineapple Juice'   from sysibm.sysdummy1 union
	select 123, date('2016-01-10'), 'ACME Corporation', 'Juice Division', 'Pineapple Juice'   from sysibm.sysdummy1 union

	select 456, date('2016-01-01'), 'XYZ Corporation' , 'Vapourware'    , 'Magic'             from sysibm.sysdummy1 union
	select 456, date('2016-01-02'), 'XYZ Corporation' , 'Vapourware'    , 'Magic'             from sysibm.sysdummy1 union
	select 456, date('2016-01-03'), 'XYZ Corporation' , 'Vapourware'    , 'Magic'             from sysibm.sysdummy1 union
	select 456, date('2016-01-04'), 'XYZ Corporation' , 'Vapourware'    , 'Magic'             from sysibm.sysdummy1 union
	select 456, date('2016-01-05'), 'XYZ Corporation' , 'Vapourware'    , 'Magic'             from sysibm.sysdummy1 union

	select 456, date('2016-01-06'), 'Bling! p/l'      , 'Vapourware'    , 'Magic'             from sysibm.sysdummy1 union
	select 456, date('2016-01-07'), 'Bling! p/l'      , 'Vapourware'    , 'Magic'             from sysibm.sysdummy1 union
	select 456, date('2016-01-08'), 'Bling! p/l'      , 'Vapourware'    , 'Magic'             from sysibm.sysdummy1 union

	select 456, date('2016-01-09'), 'Bling! p/l'      , 'Vapourware'    , 'Candy Crush Live'  from sysibm.sysdummy1 union
	select 456, date('2016-01-10'), 'Bling! p/l'      , 'Vapourware'    , 'Candy Crush Live' from sysibm.sysdummy1 
)
</code></pre>
<h3>Simple</h3>
<p>
And here is the surprisingly simple solution to partition by project. There's a more advanced version further down the page.</p>
<pre><code>
, data_rn as (
	select 
	  d.*
	, days(date1) - days(date('1900-01-01')) - row_number() over(partition by emplid, company, department, project order by date1) as rn_project
	from data d
)

select emplid, company, department, project, min(date1) as bgn_dt, max(date1) as end_dt 
from data_rn 
group by emplid, company, department, project, rn_project
order by emplid, bgn_dt
</code></pre>
<p> Which returns the results as a range of dates partitioned by employee id, company, department and project.</p>
<pre><code>

EMPLID      COMPANY          DEPARTMENT     PROJECT          BGN_DT     END_DT    
----------- ---------------- -------------- ---------------- ---------- ----------
        123 ACME Corporation TNT Division   Sticky TNT       2016-01-01 2016-01-05
        123 ACME Corporation Juice Division Apple Juice      2016-01-06 2016-01-08
        123 ACME Corporation Juice Division Pineapple Juice  2016-01-09 2016-01-10
        456 XYZ Corporation  Vapourware     Magic            2016-01-01 2016-01-05
        456 Bling! p/l       Vapourware     Magic            2016-01-06 2016-01-08
        456 Bling! p/l       Vapourware     Candy Crush Live 2016-01-09 2016-01-10

  6 record(s) selected.
</code></pre>
<h3>Advanced</h3>
<p>
Below is the more advanced version where you can play with the partition_by field. This may be something that is calculated in the data_rn step itself (as it was for me). This allows you to group or partition by company, department or project on-the-fly.</p>
<pre><code>
, data_rn as (
	select 
	  d.*
	, days(date1) - days(date('1900-01-01')) - row_number() over(partition by emplid, company                      order by date1) as rn_company
	, days(date1) - days(date('1900-01-01')) - row_number() over(partition by emplid, company, department          order by date1) as rn_department
	, days(date1) - days(date('1900-01-01')) - row_number() over(partition by emplid, company, department, project order by date1) as rn_project
	, 'department' as partition_by /* &lt;&lt; Partition by company, department or project here (try it) */
	from data d
)

select 
  partition_by
, emplid
, 
  case partition_by 
  when &#039;company&#039;    then company
  when &#039;department&#039; then company
  when &#039;project&#039;    then company
  end 
, 
  case partition_by 
  when &#039;company&#039;    then &#039; &#039;
  when &#039;department&#039; then department
  when &#039;project&#039;    then department
  end 
, 
  case partition_by 
  when &#039;company&#039;    then &#039; &#039;
  when &#039;department&#039; then &#039; &#039;
  when &#039;project&#039;    then project
  end 
, min(date1) as bgn_dt
, max(date1) as end_dt 

from 
  data_rn 

group by 
  partition_by
, emplid
, 
  case partition_by 
  when &#039;company&#039;    then company
  when &#039;department&#039; then company
  when &#039;project&#039;    then company
  end 
, 
  case partition_by 
  when &#039;company&#039;    then &#039; &#039;
  when &#039;department&#039; then department
  when &#039;project&#039;    then department
  end 
, 
  case partition_by 
  when &#039;company&#039;    then &#039; &#039;
  when &#039;department&#039; then &#039; &#039;
  when &#039;project&#039;    then project
  end 
, 
  case partition_by 
  when &#039;company&#039;    then rn_company
  when &#039;department&#039; then rn_department
  when &#039;project&#039;    then rn_project
  end 

order by 
  emplid
, bgn_dt
;
</code></pre>
<p> This returns the data partitioned by department. Note that you could quite easily partition by department for one company, and partition by project for another, or even pick out individual IDs.</p>
<pre><code>
PARTITION_BY EMPLID      COMPANY          DEPARTMENT     PROJECT          BGN_DT     END_DT    
------------ ----------- ---------------- -------------- ---------------- ---------- ----------
department           123 ACME Corporation TNT Division                    2016-01-01 2016-01-05
department           123 ACME Corporation Juice Division                  2016-01-06 2016-01-10
department           456 XYZ Corporation  Vapourware                      2016-01-01 2016-01-05
department           456 Bling! p/l       Vapourware                      2016-01-06 2016-01-10

  4 record(s) selected.
</code></pre>
<p>Based on: <a href="http://stackoverflow.com/questions/5662545/how-do-i-group-on-continuous-ranges">http://stackoverflow.com/questions/5662545/how-do-i-group-on-continuous-ranges</a></p>

  </div><a class="u-url" href="/2016/06/25/sql-to-stitch-or-group-by-a-range-of-dates.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">The PeopleSoft Experience</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">The PeopleSoft Experience</li><li><a class="u-email" href="mailto:your-email@example.com">your-email@example.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/evlPanda"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">evlPanda</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Musings, chit-chat, and sometimes useful stuff related to PeopleSoft, especially PeopleCode.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
