---
layout: post
title: Excel-To-CI CI Component Interface PeopleCode
date: 2008-10-09 03:25:00.000000000 +11:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- CI Excel Component Interface
tags: []
meta:
  blogger_blog: capital-it.blogspot.com
  blogger_author: Michael Nitschke
  blogger_0c9a3d51488c214aefd1a54a659341d6_permalink: '3165012728589886819'
author:
  login: evlpanda
  email: m.nitschke@gmail.com
  display_name: Michael Nitschke
  first_name: ''
  last_name: ''
---
<p>While building a custom Excel-To-CI Interface we discovered that each row in the spreadsheet is passed, one at a time, to the CI.  So, if for example you had data with one header and two lines you would have 2 rows on the spreadsheet.  A call would be made to the CI twice.</p>
<p>Following is example PeopleCode that will handle juggling of the unique key values needed:</p>
<p><span style="font-weight:bold;">Component.SavePreChange()</span></p>
<p><span style="font-size:78%;"><span style="font-family:courier new;">/* UQAP0780 - UQ SIR 178, Michael Nitschke 03.Sep.08 </span></p>
<p><span style="font-family:courier new;">   Handle multiples voucher lines and distribution lines.</span><br /><span style="font-family:courier new;">   The ExcelToCI spreadsheet posts across each line as a distinct voucher.</span><br /><span style="font-family:courier new;">   This code detects that the voucher already exists and marks the row as one that </span><br /><span style="font-family:courier new;">   has to be queried by PeopleCode in SavePostChange(). */</span></p>
<p><span style="font-family:courier new;">If %Mode = "A" Then</span><br /><span style="font-family:courier new;">   </span><br /><span style="font-family:courier new;">   /* Get level 0 records for component. */</span><br /><span style="font-family:courier new;">   Local Record &amp;recVCHR_HDR_STG = GetLevel0()(1).GetRecord(Record.VCHR_HDR_STG);</span><br /><span style="font-family:courier new;">   Local Record &amp;recVCHR_VNDR_STG = GetLevel0()(1).GetRecord(Record.VCHR_VNDR_STG);</span><br /><span style="font-family:courier new;">   Local Record &amp;recVCHR_BANK_STG = GetLevel0()(1).GetRecord(Record.VCHR_BANK_STG);</span><br /><span style="font-family:courier new;">   </span><br /><span style="font-family:courier new;">   /* Generate a unique VCHR_BLD_KEY_C1 value. */</span><br /><span style="font-family:courier new;">   &amp;recVCHR_HDR_STG.VCHR_BLD_KEY_C1.Value = &amp;recVCHR_HDR_STG.INVOICE_ID.Value | &amp;recVCHR_HDR_STG.INVOICE_DT.Value | &amp;recVCHR_HDR_STG.VENDOR_ID.Value | &amp;recVCHR_HDR_STG.GROSS_AMT.Value;</span><br /><span style="font-family:courier new;">   &amp;recVCHR_VNDR_STG.VCHR_BLD_KEY_C1.Value = VCHR_HDR_STG.VCHR_BLD_KEY_C1.Value;</span><br /><span style="font-family:courier new;">   &amp;recVCHR_BANK_STG.VCHR_BLD_KEY_C1.Value = VCHR_HDR_STG.VCHR_BLD_KEY_C1.Value;</span><br /><span style="font-family:courier new;">   </span><br /><span style="font-family:courier new;">   /* If VCHR_BLD_KEY_C1 value already exists we need to create a 2nd key value for VCHR_BLD_KEY_C2. </span><br /><span style="font-family:courier new;">      &gt; See Component.SavePostChange PeopleCode for where this value/mark is used to cleanup rows. */</span><br /><span style="font-family:courier new;">   Local integer &amp;count = 0;</span><br /><span style="font-family:courier new;">   SQLExec("SELECT count(*) FROM %Table(VCHR_HDR_STG) WHERE VCHR_BLD_KEY_C1 = :1", VCHR_HDR_STG.VCHR_BLD_KEY_C1.Value, &amp;count);</span><br /><span style="font-family:courier new;">   If &amp;count  0 Then</span><br /><span style="font-family:courier new;">      VCHR_HDR_STG.VCHR_BLD_KEY_C2.Value = "X" | &amp;count;</span><br /><span style="font-family:courier new;">      &amp;recVCHR_VNDR_STG.VCHR_BLD_KEY_C2.Value = VCHR_HDR_STG.VCHR_BLD_KEY_C2.Value;</span><br /><span style="font-family:courier new;">      &amp;recVCHR_BANK_STG.VCHR_BLD_KEY_C2.Value = VCHR_HDR_STG.VCHR_BLD_KEY_C2.Value;</span><br /><span style="font-family:courier new;">   End-If;</span><br /><span style="font-family:courier new;">   </span><br /><span style="font-family:courier new;">End-If;</span><br /><span style="font-family:courier new;">/* UQAP0780 - UQ SIR 178 End */</span></span></p>
<p>Component.SavePostChange()<br /><span style="font-size:78%;"><span style="font-family:courier new;">/* UQAP0780, UQ SIR 178 Michael Nitschke 03.Sep.2008</span><br /><span style="font-family:courier new;">   Cleanup records that have been inserted as single vouchers but are really*</span><br /><span style="font-family:courier new;">   data for child rows (line and distribution) of already existing vouchers.</span><br /><span style="font-family:courier new;">   These are marked with key field UQ_VCHRHDR_ST_V.VCHR_BLD_KEY_C2 value = 'X'. </span></p>
<p><span style="font-family:courier new;">   NOTE that this cleanup process will also allow duplicate vouchers to be posted</span><br /><span style="font-family:courier new;">   from the spreadsheet to the staging tables, the duplicates will be cleaned up/removed. */</span></p>
<p><span style="font-family:courier new;">/* Level 0 records are easy, if VCHR_BLD_KEY_C1 = "X" then delete the record. </span><br /><span style="font-family:courier new;">   (b is for buffer) */</span></p>
<p><span style="font-family:courier new;">Local Record &amp;recVCHR_HDR_STGb = GetLevel0()(1).GetRecord(Record.VCHR_HDR_STG);</span><br /><span style="font-family:courier new;">If Left(&amp;recVCHR_HDR_STGb.VCHR_BLD_KEY_C2.Value, 1) = "X" Then</span><br /><span style="font-family:courier new;">   </span><br /><span style="font-family:courier new;">   Local Record &amp;recVCHR_HDR_STG = CreateRecord(Record.VCHR_HDR_STG);</span><br /><span style="font-family:courier new;">   Local Record &amp;recVCHR_VNDR_STG = CreateRecord(Record.VCHR_VNDR_STG);</span><br /><span style="font-family:courier new;">   Local Record &amp;recVCHR_BANK_STG = CreateRecord(Record.VCHR_BANK_STG);</span><br /><span style="font-family:courier new;">   </span><br /><span style="font-family:courier new;">   &amp;recVCHR_HDR_STGb.CopyFieldsTo(&amp;recVCHR_HDR_STG);</span><br /><span style="font-family:courier new;">   &amp;recVCHR_HDR_STGb.CopyFieldsTo(&amp;recVCHR_VNDR_STG);</span><br /><span style="font-family:courier new;">   &amp;recVCHR_HDR_STGb.CopyFieldsTo(&amp;recVCHR_BANK_STG);</span><br /><span style="font-family:courier new;">   </span><br /><span style="font-family:courier new;">   &amp;x = &amp;recVCHR_HDR_STG.Delete();</span><br /><span style="font-family:courier new;">   &amp;x = &amp;recVCHR_VNDR_STG.Delete();</span><br /><span style="font-family:courier new;">   &amp;x = &amp;recVCHR_BANK_STG.Delete();</span><br /><span style="font-family:courier new;">   </span><br /><span style="font-family:courier new;">End-If;</span></p>
<p><span style="font-family:courier new;">/* Line record (b for buffer). */</span><br /><span style="font-family:courier new;">Local Record &amp;recVCHR_LINE_STGb = GetLevel0()(1).GetRowset(Scroll.VCHR_LINE_STG)(1).GetRecord(Record.VCHR_LINE_STG); /* (There will only ever be one row) */</span><br /><span style="font-family:courier new;">If Left(&amp;recVCHR_LINE_STGb.VCHR_BLD_KEY_C2.Value, 1) = "X" Then</span><br /><span style="font-family:courier new;">   </span><br /><span style="font-family:courier new;">   Local Record &amp;recVCHR_LINE_STG = CreateRecord(Record.VCHR_LINE_STG);</span><br /><span style="font-family:courier new;">   &amp;recVCHR_LINE_STGb.CopyFieldsTo(&amp;recVCHR_LINE_STG);</span><br /><span style="font-family:courier new;">   &amp;tmpKeyVal = &amp;recVCHR_LINE_STG.VCHR_BLD_KEY_C2.Value;</span><br /><span style="font-family:courier new;">   &amp;recVCHR_LINE_STG.VCHR_BLD_KEY_C2.Value = "";</span><br /><span style="font-family:courier new;">   </span><br /><span style="font-family:courier new;">   /* If a duplicate row exists (sans the "X" value) then delete. </span><br /><span style="font-family:courier new;">      Else a unique row so update/remove the "X". */</span><br /><span style="font-family:courier new;">   If &amp;recVCHR_LINE_STG.SelectByKey() Then</span><br /><span style="font-family:courier new;">      &amp;recVCHR_LINE_STG.VCHR_BLD_KEY_C2.Value = &amp;tmpKeyVal;</span><br /><span style="font-family:courier new;">      &amp;x = &amp;recVCHR_LINE_STG.Delete();</span><br /><span style="font-family:courier new;">   Else</span><br /><span style="font-family:courier new;">      SQLExec("UPDATE %Table(VCHR_LINE_STG) SET VCHR_BLD_KEY_C2 = ' ' WHERE %KeyEqual(:1)", &amp;recVCHR_LINE_STGb);</span><br /><span style="font-family:courier new;">   End-If;</span><br /><span style="font-family:courier new;">   </span><br /><span style="font-family:courier new;">End-If;</span></p>
<p><span style="font-family:courier new;">/* Distribution record. (b is for buffer) */</span><br /><span style="font-family:courier new;">Local Record &amp;recVCHR_DIST_STGb = GetLevel0()(1).GetRowset(Scroll.VCHR_LINE_STG)(1).GetRowset(Scroll.VCHR_DIST_STG)(1).GetRecord(Record.VCHR_DIST_STG); /* (There will only ever be one row) */</span><br /><span style="font-family:courier new;">If Left(&amp;recVCHR_DIST_STGb.VCHR_BLD_KEY_C2.Value, 1) = "X" Then</span><br /><span style="font-family:courier new;">   </span><br /><span style="font-family:courier new;">   Local Record &amp;recVCHR_DIST_STG = CreateRecord(Record.VCHR_DIST_STG);</span><br /><span style="font-family:courier new;">   &amp;recVCHR_DIST_STGb.CopyFieldsTo(&amp;recVCHR_DIST_STG);</span><br /><span style="font-family:courier new;">   &amp;tmpKeyVal = &amp;recVCHR_DIST_STG.VCHR_BLD_KEY_C2.Value;</span><br /><span style="font-family:courier new;">   &amp;recVCHR_DIST_STG.VCHR_BLD_KEY_C2.Value = "";</span><br /><span style="font-family:courier new;">   </span><br /><span style="font-family:courier new;">   /* If a duplicate row exists (sans the "X" value) then delete. </span><br /><span style="font-family:courier new;">      Else a unique row so update/remove the "X". */</span><br /><span style="font-family:courier new;">   If &amp;recVCHR_DIST_STG.SelectByKey() Then</span><br /><span style="font-family:courier new;">      &amp;recVCHR_DIST_STG.VCHR_BLD_KEY_C2.Value = &amp;tmpKeyVal;</span><br /><span style="font-family:courier new;">      &amp;x = &amp;recVCHR_DIST_STG.Delete();</span><br /><span style="font-family:courier new;">   Else</span><br /><span style="font-family:courier new;">      SQLExec("UPDATE %Table(VCHR_DIST_STG) SET VCHR_BLD_KEY_C2 = ' ' WHERE %KeyEqual(:1)", &amp;recVCHR_DIST_STGb);</span><br /><span style="font-family:courier new;">   End-If;</span><br /><span style="font-family:courier new;">   </span><br /><span style="font-family:courier new;">End-If;</span></p>
<p><span style="font-family:courier new;">/* UQAP0780, UQ SIR 178 End */</span></span></p>
