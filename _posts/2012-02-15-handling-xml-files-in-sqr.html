---
layout: post
title: Handling XML Files in SQR
date: 2012-02-15 23:23:00.000000000 +11:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories: []
tags: []
meta:
  blogger_blog: capital-it.blogspot.com
  blogger_author: Michael Nitschke
  blogger_0c9a3d51488c214aefd1a54a659341d6_permalink: '16135267937089495'
author:
  login: evlpanda
  email: m.nitschke@gmail.com
  display_name: Michael Nitschke
  first_name: ''
  last_name: ''
---
<p>Nice little example of reading an XML file, {input}, and using it to update values in a Table. Note that it first inserts the XML file's data into a CLOB field at the end of the Table it is updating. Field.RAWXML.</p>
<p> 
<pre style="font-family:Andale Mono, Lucida Console, Monaco, fixed, monospace;color:#000000;background-color:#eee;font-size:12px;border:1px dashed #999999;line-height:14px;padding:5px;overflow:auto;width:100%;"><code>!*******************************************************************************<br />! Procedure:  Read-Input-File                                                  *<br />! Description: Loads Request File data into Suspense tables                    *<br />!              using Oracle XML DB functions to extract data from the XML      *      <br />!*******************************************************************************<br />!<br />begin-procedure Read-Input-File    <br /><br />#debugp show ''<br />#debugp show 'Enter procedure Read-Input-File'<br /><br />  ! Read file in <br />  open $Request_Filename as {INPUT} for-reading record=32767:fixed_nolf status=#result<br />  if #result  0<br />    show {REQUEST_FILE_OPEN_ERR_MSG}<br />    stop quiet<br />  end-if<br /><br />  let $SQL-STATEMENT = 'amssr197.sqr, Read-Input-File, insert into PS_AMS_CART_RQ_HDR' <br />  <br />begin-sql on-error=Sql-Error<br />INSERT INTO PS_AMS_CART_RQ_HDR (<br />        PRCSINSTANCE,<br />        AMS_SYSTEM_CODE,<br />        AMS_CART_TIME_STMP,<br />        AMS_ABN_NBR,<br />        AMS_CART_USER_ID,<br />        AMS_CART_RECS,<br />        RAWXML<br />   ) values ( <br />        #prcs_process_instance,<br />        ' ',<br />        0,<br />        0,<br />        ' ',<br />        0,<br />        empty_clob()<br />    )        <br />end-sql<br /><br />  <br />  while 1=1<br />    let $xml = ''<br />    read {INPUT} into $xml:32767 status=#result<br />    <br />    if #result  0<br />        show {SUSPENSE_TABLE_ERR_MSG}<br />        stop quiet<br />    end-if<br />    if #end-file<br />        break<br />    end-if<br />    <br />        let #xml = length($xml)<br />        <br />    ! Begin: QC1555<br />    ! The given XML file may have Microsoft Byte Order Mark at the beginning. If so just trim it off else can't be read.<br />    ! http://en.wikipedia.org/wiki/UTF-8#Byte_order_mark<br />    let $checkBOM = substr($xml, 1,4) <br />    if $checkBOM = '0xEF' or $checkBOM = '0xBB' or $checkBOM = '0xBF'<br />        let $xml = substr($xml, 5, #xml - 4)<br />    end-if <br />    let $checkBOM = substr($xml, 1,3) <br />    if $checkBOM = 'ï»¿' <br />        let $xml = substr($xml, 4, #xml - 3)<br />    end-if<br />    let #xml = length($xml)<br />    ! End: QC1555<br />    <br />#ifdef debugx<br />         show '$checkBOM= ' $checkBOM<br />        show '    xml : ' $xml<br />#endif <br /><br />    let $SQL-STATEMENT = 'amssr197.sqr, Read-Input-File, update PS_AMS_CART_RQ_HDR(RAWXML)' <br />  <br />begin-sql on-error=Sql-Error<br />declare<br />    cartXml CLOB;;<br />begin<br />    SELECT rawXML INTO cartXML<br />    FROM PS_AMS_CART_RQ_HDR <br />    WHERE PRCSINSTANCE = #prcs_process_instance<br />    FOR UPDATE;;<br />    <br />    DBMS_LOB.WRITEAPPEND(cartXml, #xml, $xml);;<br />end;;<br />end-sql<br />#ifdef debugx<br />    commit<br />#endif<br /><br />  end-while<br />  <br />  let $SQL-STATEMENT = 'amssr197.sqr, Read-Input-File, select PS_AMS_CART_RQ_HDR' <br />  <br />begin-select on-error=Sql-Error<br />hdr.systemCode<br />hdr.cartTimeStamp<br />hdr.instAbn<br />hdr.userId<br />hdr.numRecords<br /><br />   FROM <br />   XMLTABLE('/studentStudyCircRequest005'<br />      PASSING (SELECT XMLTYPE.createxml(rawXML) FROM PS_AMS_CART_RQ_HDR WHERE PRCSINSTANCE = #prcs_process_instance) <br />      COLUMNS<br />        systemCode      varchar2(4)  PATH 'header/system',<br />        cartTimeStamp   number(14,0) PATH 'header/timestamp',<br />        instAbn         number(11,0) PATH 'header/instAbn',<br />        userId          varchar2(12) PATH 'header/userId',<br />        numRecords      number(38,0) PATH 'trailer/numRecords'<br />        ) hdr<br />end-select<br /><br />    let $SQL-STATEMENT = 'amssr197.sqr, Read-Input-File, update PS_AMS_CART_RQ_HDR' <br />  <br />begin-sql !on-error=Sql-Error<br />UPDATE PS_AMS_CART_RQ_HDR <br />        set AMS_SYSTEM_CODE    = &amp;hdr.systemCode,<br />            AMS_CART_TIME_STMP = &amp;hdr.cartTimeStamp,<br />            AMS_ABN_NBR        = &amp;hdr.instAbn,<br />            AMS_CART_USER_ID   = &amp;hdr.userId,<br />            AMS_CART_RECS      = &amp;hdr.numRecords<br />   WHERE PRCSINSTANCE = #prcs_process_instance <br />end-sql   <br /></code></pre>
