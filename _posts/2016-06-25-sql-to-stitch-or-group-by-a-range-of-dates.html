---
layout: post
title: SQL to Stitch or Group By a Range of Dates
date: 2016-06-25 06:38:52.000000000 +10:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories: []
tags: []
meta:
  _rest_api_published: '1'
  _rest_api_client_id: "-1"
  _publicize_job_id: '24171318615'
author:
  login: evlpanda
  email: m.nitschke@gmail.com
  display_name: Michael Nitschke
  first_name: ''
  last_name: ''
---
<p>
So, for a reason beyond your control you have data in the following format:</p>
<pre><code>
EMPLID      DATE1      COMPANY          DEPARTMENT     PROJECT         
----------- ---------- ---------------- -------------- ----------------
        123 2016-01-01 ACME Corporation TNT Division   Sticky TNT      
        123 2016-01-02 ACME Corporation TNT Division   Sticky TNT      
        123 2016-01-03 ACME Corporation TNT Division   Sticky TNT      
        123 2016-01-04 ACME Corporation TNT Division   Sticky TNT      
        123 2016-01-05 ACME Corporation TNT Division   Sticky TNT      
        123 2016-01-06 ACME Corporation Juice Division Apple Juice     
        123 2016-01-07 ACME Corporation Juice Division Apple Juice     
        123 2016-01-08 ACME Corporation Juice Division Apple Juice     
        123 2016-01-09 ACME Corporation Juice Division Pineapple Juice 
        123 2016-01-10 ACME Corporation Juice Division Pineapple Juice 
        456 2016-01-01 XYZ Corporation  Vapourware     Magic           
        456 2016-01-02 XYZ Corporation  Vapourware     Magic           
        456 2016-01-03 XYZ Corporation  Vapourware     Magic           
        456 2016-01-04 XYZ Corporation  Vapourware     Magic           
        456 2016-01-05 XYZ Corporation  Vapourware     Magic           
        456 2016-01-06 Bling! p/l       Vapourware     Magic           
        456 2016-01-07 Bling! p/l       Vapourware     Magic           
        456 2016-01-08 Bling! p/l       Vapourware     Magic           
        456 2016-01-09 Bling! p/l       Vapourware     Candy Crush Live
        456 2016-01-10 Bling! p/l       Vapourware     Candy Crush Live
</code></pre>
<p>
A collection of employees, <i>individual dates</i>, and the company, department and project they were in on that date. And you would like to get the date <i>ranges</i> that they were in a company, or department, or project.</p>
<p>Here is the data to play with:</p>
<pre><code>
with data (emplid, date1, company, department, project) as (

	select 123, date('2016-01-01'), 'ACME Corporation', 'TNT Division'  , 'Sticky TNT'        from sysibm.sysdummy1 union
	select 123, date('2016-01-02'), 'ACME Corporation', 'TNT Division'  , 'Sticky TNT'        from sysibm.sysdummy1 union
	select 123, date('2016-01-03'), 'ACME Corporation', 'TNT Division'  , 'Sticky TNT'        from sysibm.sysdummy1 union
	select 123, date('2016-01-04'), 'ACME Corporation', 'TNT Division'  , 'Sticky TNT'        from sysibm.sysdummy1 union
	select 123, date('2016-01-05'), 'ACME Corporation', 'TNT Division'  , 'Sticky TNT'        from sysibm.sysdummy1 union

	select 123, date('2016-01-06'), 'ACME Corporation', 'Juice Division', 'Apple Juice'       from sysibm.sysdummy1 union
	select 123, date('2016-01-07'), 'ACME Corporation', 'Juice Division', 'Apple Juice'       from sysibm.sysdummy1 union
	select 123, date('2016-01-08'), 'ACME Corporation', 'Juice Division', 'Apple Juice'       from sysibm.sysdummy1 union

	select 123, date('2016-01-09'), 'ACME Corporation', 'Juice Division', 'Pineapple Juice'   from sysibm.sysdummy1 union
	select 123, date('2016-01-10'), 'ACME Corporation', 'Juice Division', 'Pineapple Juice'   from sysibm.sysdummy1 union

	select 456, date('2016-01-01'), 'XYZ Corporation' , 'Vapourware'    , 'Magic'             from sysibm.sysdummy1 union
	select 456, date('2016-01-02'), 'XYZ Corporation' , 'Vapourware'    , 'Magic'             from sysibm.sysdummy1 union
	select 456, date('2016-01-03'), 'XYZ Corporation' , 'Vapourware'    , 'Magic'             from sysibm.sysdummy1 union
	select 456, date('2016-01-04'), 'XYZ Corporation' , 'Vapourware'    , 'Magic'             from sysibm.sysdummy1 union
	select 456, date('2016-01-05'), 'XYZ Corporation' , 'Vapourware'    , 'Magic'             from sysibm.sysdummy1 union

	select 456, date('2016-01-06'), 'Bling! p/l'      , 'Vapourware'    , 'Magic'             from sysibm.sysdummy1 union
	select 456, date('2016-01-07'), 'Bling! p/l'      , 'Vapourware'    , 'Magic'             from sysibm.sysdummy1 union
	select 456, date('2016-01-08'), 'Bling! p/l'      , 'Vapourware'    , 'Magic'             from sysibm.sysdummy1 union

	select 456, date('2016-01-09'), 'Bling! p/l'      , 'Vapourware'    , 'Candy Crush Live'  from sysibm.sysdummy1 union
	select 456, date('2016-01-10'), 'Bling! p/l'      , 'Vapourware'    , 'Candy Crush Live' from sysibm.sysdummy1 
)
</code></pre>
<h3>Simple</h3>
<p>
And here is the surprisingly simple solution to partition by project. There's a more advanced version further down the page.</p>
<pre><code>
, data_rn as (
	select 
	  d.*
	, days(date1) - days(date('1900-01-01')) - row_number() over(partition by emplid, company, department, project order by date1) as rn_project
	from data d
)

select emplid, company, department, project, min(date1) as bgn_dt, max(date1) as end_dt 
from data_rn 
group by emplid, company, department, project, rn_project
order by emplid, bgn_dt
</code></pre>
<p> Which returns the results as a range of dates partitioned by employee id, company, department and project.</p>
<pre><code>

EMPLID      COMPANY          DEPARTMENT     PROJECT          BGN_DT     END_DT    
----------- ---------------- -------------- ---------------- ---------- ----------
        123 ACME Corporation TNT Division   Sticky TNT       2016-01-01 2016-01-05
        123 ACME Corporation Juice Division Apple Juice      2016-01-06 2016-01-08
        123 ACME Corporation Juice Division Pineapple Juice  2016-01-09 2016-01-10
        456 XYZ Corporation  Vapourware     Magic            2016-01-01 2016-01-05
        456 Bling! p/l       Vapourware     Magic            2016-01-06 2016-01-08
        456 Bling! p/l       Vapourware     Candy Crush Live 2016-01-09 2016-01-10

  6 record(s) selected.
</code></pre>
<h3>Advanced</h3>
<p>
Below is the more advanced version where you can play with the partition_by field. This may be something that is calculated in the data_rn step itself (as it was for me). This allows you to group or partition by company, department or project on-the-fly.</p>
<pre><code>
, data_rn as (
	select 
	  d.*
	, days(date1) - days(date('1900-01-01')) - row_number() over(partition by emplid, company                      order by date1) as rn_company
	, days(date1) - days(date('1900-01-01')) - row_number() over(partition by emplid, company, department          order by date1) as rn_department
	, days(date1) - days(date('1900-01-01')) - row_number() over(partition by emplid, company, department, project order by date1) as rn_project
	, 'department' as partition_by /* &lt;&lt; Partition by company, department or project here (try it) */
	from data d
)

select 
  partition_by
, emplid
, 
  case partition_by 
  when &#039;company&#039;    then company
  when &#039;department&#039; then company
  when &#039;project&#039;    then company
  end 
, 
  case partition_by 
  when &#039;company&#039;    then &#039; &#039;
  when &#039;department&#039; then department
  when &#039;project&#039;    then department
  end 
, 
  case partition_by 
  when &#039;company&#039;    then &#039; &#039;
  when &#039;department&#039; then &#039; &#039;
  when &#039;project&#039;    then project
  end 
, min(date1) as bgn_dt
, max(date1) as end_dt 

from 
  data_rn 

group by 
  partition_by
, emplid
, 
  case partition_by 
  when &#039;company&#039;    then company
  when &#039;department&#039; then company
  when &#039;project&#039;    then company
  end 
, 
  case partition_by 
  when &#039;company&#039;    then &#039; &#039;
  when &#039;department&#039; then department
  when &#039;project&#039;    then department
  end 
, 
  case partition_by 
  when &#039;company&#039;    then &#039; &#039;
  when &#039;department&#039; then &#039; &#039;
  when &#039;project&#039;    then project
  end 
, 
  case partition_by 
  when &#039;company&#039;    then rn_company
  when &#039;department&#039; then rn_department
  when &#039;project&#039;    then rn_project
  end 

order by 
  emplid
, bgn_dt
;
</code></pre>
<p> This returns the data partitioned by department. Note that you could quite easily partition by department for one company, and partition by project for another, or even pick out individual IDs.</p>
<pre><code>
PARTITION_BY EMPLID      COMPANY          DEPARTMENT     PROJECT          BGN_DT     END_DT    
------------ ----------- ---------------- -------------- ---------------- ---------- ----------
department           123 ACME Corporation TNT Division                    2016-01-01 2016-01-05
department           123 ACME Corporation Juice Division                  2016-01-06 2016-01-10
department           456 XYZ Corporation  Vapourware                      2016-01-01 2016-01-05
department           456 Bling! p/l       Vapourware                      2016-01-06 2016-01-10

  4 record(s) selected.
</code></pre>
<p>Based on: <a href="http://stackoverflow.com/questions/5662545/how-do-i-group-on-continuous-ranges">http://stackoverflow.com/questions/5662545/how-do-i-group-on-continuous-ranges</a></p>
